# =============================================================================
# ModSecurity Main Configuration
# Reference: https://github.com/owasp-modsecurity/ModSecurity/blob/v3/master/modsecurity.conf-recommended
# =============================================================================

# -- Rule Engine --
# On        = actively block
# DetectionOnly = log only, never block (use for initial tuning)
# Off       = disabled
SecRuleEngine On

# -- Request Body --
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject

# -- Response Body --
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# -- File Uploads --
SecUploadDir /tmp
SecUploadKeepFiles RelevantOnly
SecUploadFileMode 0600

# -- Regex Limits --
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# -- Debug Logging --
# Level 0=off  1=error  3=warnings  5=notices  9=everything
SecDebugLog /var/log/waf/modsec_debug.log
SecDebugLogLevel 0

# -- Audit Logging --
# On           = log all transactions
# Off          = disabled
# RelevantOnly = log only blocked/error transactions (recommended for prod)
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"

# Audit log parts:
# A = request line & headers     B = request body
# C = intended response headers  D = intermediate response
# E = intended response body     F = final response headers
# H = audit log trailer          I = multipart req body (A+B combined)
# J = uploaded file info         K = matched rules list
# Z = end marker
SecAuditLogParts ABIJDEFHKZ

SecAuditLogType Serial
SecAuditLog /var/log/waf/modsec_audit.log

# -- Misc --
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile /etc/nginx/modsec/unicode.mapping 20127
SecStatusEngine Off

# -- Default Actions --
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"
