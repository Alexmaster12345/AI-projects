# =============================================================================
# OWASP CRS Setup Configuration
# Applied on top of the downloaded crs-setup.conf.example
# =============================================================================

# -- Paranoia Level --
# 1 = low false positives (recommended for most sites)
# 2 = more rules, some false positives
# 3 = paranoid — high security, more tuning needed
# 4 = maximum — many false positives, only for hardened APIs
SecAction \
  "id:900000,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  tag:'OWASP_CRS',\
  ver:'OWASP_CRS/4.0.0',\
  setvar:tx.blocking_paranoia_level=1"

# Detection-only paranoia level (for tuning)
SecAction \
  "id:900001,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  tag:'OWASP_CRS',\
  setvar:tx.detection_paranoia_level=2"

# -- Anomaly Scoring Thresholds --
# Inbound threshold: block request if score >= this value
# Default 5 (one critical hit blocks)
SecAction \
  "id:900110,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  tag:'OWASP_CRS',\
  setvar:tx.inbound_anomaly_score_threshold=5"

# Outbound threshold (response scanning)
SecAction \
  "id:900200,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  tag:'OWASP_CRS',\
  setvar:tx.outbound_anomaly_score_threshold=4"

# -- HTTP Policy --
# Allowed HTTP methods
SecAction \
  "id:900200,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE PATCH OPTIONS'"

# Allowed content types
SecAction \
  "id:900220,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# Max number of arguments
SecAction \
  "id:900300,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  setvar:tx.max_num_args=255"

# Max argument length
SecAction \
  "id:900310,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  setvar:tx.arg_length=400"

# Max total argument length
SecAction \
  "id:900320,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  setvar:tx.arg_name_length=100"

# Max file upload size (100 MB)
SecAction \
  "id:900330,\
  phase:1,\
  pass,\
  t:none,\
  nolog,\
  setvar:tx.max_file_size=104857600"

# -- Geo-blocking (optional, requires GeoIP) --
# Uncomment to block specific countries
# SecGeoLookupDB /etc/nginx/modsec/GeoLite2-Country.mmdb
# SecRule GEO:COUNTRY_CODE "@pm CN RU KP IR" \
#   "id:900500,phase:1,deny,status:403,log,msg:'Country blocked by WAF policy'"

# -- IP Reputation (optional) --
# SecAction \
#   "id:900600,phase:1,pass,t:none,nolog,\
#   setvar:tx.use_ip_reputation=1"
