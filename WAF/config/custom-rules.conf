# =============================================================================
# Custom WAF Rules
# Place in /etc/nginx/modsec/custom-rules.conf
# Rule IDs: 1000-1999 (reserved for local custom rules)
# =============================================================================

# -----------------------------------------------------------------------------
# 1001 — Block requests with no User-Agent
# -----------------------------------------------------------------------------
SecRule &REQUEST_HEADERS:User-Agent "@eq 0" \
  "id:1001,\
  phase:1,\
  deny,\
  status:400,\
  log,\
  msg:'Missing User-Agent header',\
  tag:'custom/headers'"

# -----------------------------------------------------------------------------
# 1002 — Block known scanner/bot User-Agents
# -----------------------------------------------------------------------------
SecRule REQUEST_HEADERS:User-Agent \
  "@pm nikto sqlmap nmap masscan zgrab dirbuster dirb gobuster nuclei wfuzz hydra curl/7.1 python-requests libwww-perl" \
  "id:1002,\
  phase:1,\
  deny,\
  status:403,\
  log,\
  msg:'Known scanner or attack tool User-Agent detected: %{REQUEST_HEADERS.User-Agent}',\
  tag:'custom/scanner'"

# -----------------------------------------------------------------------------
# 1003 — Block requests with excessively long URIs (> 2048 chars)
# -----------------------------------------------------------------------------
SecRule REQUEST_URI "@gt 2048" \
  "id:1003,\
  phase:1,\
  deny,\
  status:414,\
  log,\
  msg:'URI too long: %{REQUEST_URI_RAW}',\
  tag:'custom/protocol',\
  t:length"

# -----------------------------------------------------------------------------
# 1004 — Block null bytes in request
# -----------------------------------------------------------------------------
SecRule REQUEST_URI|REQUEST_HEADERS|ARGS "@rx \\x00" \
  "id:1004,\
  phase:1,\
  deny,\
  status:400,\
  log,\
  msg:'Null byte detected in request',\
  tag:'custom/protocol'"

# -----------------------------------------------------------------------------
# 1005 — Block common web shell filenames
# -----------------------------------------------------------------------------
SecRule REQUEST_URI \
  "@rx (?i)(c99|r57|shell|webshell|cmd|eval|base64_decode|passthru|system|exec|popen)\.(php|asp|aspx|jsp)" \
  "id:1005,\
  phase:1,\
  deny,\
  status:403,\
  log,\
  msg:'Web shell access attempt: %{REQUEST_URI}',\
  tag:'custom/webshell'"

# -----------------------------------------------------------------------------
# 1006 — Block directory traversal sequences
# -----------------------------------------------------------------------------
SecRule REQUEST_URI|ARGS \
  "@rx (?:\.{2}[/\\\\]|[/\\\\]\.{2})" \
  "id:1006,\
  phase:1,\
  deny,\
  status:400,\
  log,\
  msg:'Directory traversal attempt detected',\
  tag:'custom/lfi'"

# -----------------------------------------------------------------------------
# 1007 — Block requests with suspicious content-type + no body
# -----------------------------------------------------------------------------
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
  "id:1007,\
  phase:1,\
  chain,\
  log,\
  msg:'POST/PUT with no content-type',\
  tag:'custom/protocol'"
  SecRule &REQUEST_HEADERS:Content-Type "@eq 0" \
    "deny,status:400"

# -----------------------------------------------------------------------------
# 1010-1012 — Simple rate limiting via IP (100 req/60 sec)
# (ModSecurity collection-based rate limiting)
# -----------------------------------------------------------------------------
SecAction \
  "id:1010,\
  phase:1,\
  pass,\
  nolog,\
  initcol:ip=%{REMOTE_ADDR}"

SecRule IP:REQUEST_COUNTER "@gt 100" \
  "id:1011,\
  phase:1,\
  deny,\
  status:429,\
  log,\
  msg:'IP rate limit exceeded: %{REMOTE_ADDR}',\
  tag:'custom/ratelimit',\
  expirevar:ip.request_counter=60"

SecAction \
  "id:1012,\
  phase:1,\
  pass,\
  nolog,\
  setvar:ip.request_counter=+1"

# -----------------------------------------------------------------------------
# 1020 — Block known bad IPs (add IPs to the list below)
# -----------------------------------------------------------------------------
# SecRule REMOTE_ADDR "@ipMatchFromFile /etc/nginx/modsec/blocked-ips.txt" \
#   "id:1020,\
#   phase:1,\
#   deny,\
#   status:403,\
#   log,\
#   msg:'Blocked IP: %{REMOTE_ADDR}',\
#   tag:'custom/blocklist'"

# -----------------------------------------------------------------------------
# 1030 — Whitelist trusted IPs (bypass WAF rules)
# -----------------------------------------------------------------------------
# SecRule REMOTE_ADDR "@ipMatch 192.168.50.0/24 10.0.0.0/8" \
#   "id:1030,\
#   phase:1,\
#   allow,\
#   nolog,\
#   msg:'Trusted IP whitelist',\
#   tag:'custom/whitelist'"

# -----------------------------------------------------------------------------
# 1040 — Block HTTP request smuggling attempts
# -----------------------------------------------------------------------------
SecRule REQUEST_HEADERS:Transfer-Encoding "!@rx ^(chunked|identity)$" \
  "id:1040,\
  phase:1,\
  deny,\
  status:400,\
  log,\
  msg:'Invalid Transfer-Encoding header: %{REQUEST_HEADERS.Transfer-Encoding}',\
  tag:'custom/protocol'"

# -----------------------------------------------------------------------------
# 1050 — Log but allow — detect but don't block potential SQLi (for tuning)
# Uncomment SecRuleEngine DetectionOnly in modsecurity.conf to use this safely
# -----------------------------------------------------------------------------
# SecRule ARGS "@detectSQLi" \
#   "id:1050,\
#   phase:2,\
#   log,\
#   pass,\
#   msg:'Potential SQL injection detected (detection only): %{MATCHED_VAR}',\
#   tag:'custom/sqli-detect'"
