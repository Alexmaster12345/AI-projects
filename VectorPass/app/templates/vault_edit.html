{% extends "base.html" %}

{% block nav_actions %}
<a class="btn btn-outline-light btn-sm" href="/vault">Back</a>
<form method="post" action="/logout" class="m-0">
  <button class="btn btn-outline-light btn-sm" type="submit">Logout</button>
</form>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 m-0">{% if mode == 'new' %}New entry{% else %}Edit entry{% endif %}</h1>
      {% if mode == 'edit' %}
      <form method="post" action="/vault/{{ entry.id }}/delete" onsubmit="return confirm('Delete this entry?');">
        <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
      </form>
      {% endif %}
    </div>

    {% if error %}
      <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% endif %}

    <div class="card shadow-sm">
      <div class="card-body p-4">
        <form method="post" action="/vault/save" autocomplete="off">
          <input type="hidden" name="entry_id" value="{% if entry %}{{ entry.id }}{% endif %}">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Site name</label>
              <input class="form-control" name="site_name" required value="{% if entry %}{{ entry.site_name }}{% endif %}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tags</label>
              <input class="form-control" name="tags" placeholder="work, personal" value="{{ tags }}">
            </div>
            <div class="col-12">
              <label class="form-label">URL</label>
              <input class="form-control" name="url" required value="{% if entry %}{{ entry.url }}{% endif %}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Username / Email</label>
              <input class="form-control" name="login_username" required value="{% if entry %}{{ entry.login_username }}{% endif %}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Password</label>
              <div class="input-group">
                <input id="vpPassword" class="form-control" type="password" name="password" required value="{{ password }}">
                <button id="vpShowBtn" class="btn btn-outline-secondary" type="button" onclick="VectorPass.togglePassword('vpPassword', this)">Show</button>
                <button class="btn btn-outline-success" type="button" data-bs-toggle="modal" data-bs-target="#vpGenModal" id="vpGenBtn">Generate</button>
                {% if mode == 'edit' %}
                <button class="btn btn-outline-primary" type="button" data-entry-id="{{ entry.id }}" onclick="VectorPass.revealAndCopy(this)">Reveal & Copy</button>
                {% endif %}
              </div>
              <div class="mt-1">
                <div class="progress" style="height:5px">
                  <div id="vpStrengthBar" class="progress-bar" style="width:0%;transition:width .3s,background .3s"></div>
                </div>
                <small id="vpStrengthText" class="fw-semibold"></small>
              </div>
              <div class="form-text">Stored encrypted.</div>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" rows="4">{{ notes }}</textarea>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Save</button>
            {% if mode == 'edit' %}
              <a class="btn btn-outline-secondary" href="/vault/{{ entry.id }}/edit">Reset</a>
            {% else %}
              <a class="btn btn-outline-secondary" href="/vault">Cancel</a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

<!-- Password Generator Modal -->
<div class="modal fade" id="vpGenModal" tabindex="-1" aria-labelledby="vpGenModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="vpGenModalLabel">ðŸ”‘ Password Generator</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-semibold">Generated password</label>
          <div class="input-group">
            <input id="vpGenPreview" type="text" class="form-control font-monospace" readonly>
            <button class="btn btn-outline-secondary" type="button" id="vpGenRefresh">â†»</button>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Length: <strong id="vpGenLengthVal">20</strong></label>
          <input id="vpGenLength" type="range" class="form-range" min="8" max="64" value="20"
                 oninput="document.getElementById('vpGenLengthVal').textContent=this.value">
        </div>
        <div class="row g-2">
          <div class="col-6"><div class="form-check">
            <input class="form-check-input" type="checkbox" id="vpGenLower" checked>
            <label class="form-check-label" for="vpGenLower">Lowercase (a-z)</label>
          </div></div>
          <div class="col-6"><div class="form-check">
            <input class="form-check-input" type="checkbox" id="vpGenUpper" checked>
            <label class="form-check-label" for="vpGenUpper">Uppercase (A-Z)</label>
          </div></div>
          <div class="col-6"><div class="form-check">
            <input class="form-check-input" type="checkbox" id="vpGenDigits" checked>
            <label class="form-check-label" for="vpGenDigits">Numbers (0-9)</label>
          </div></div>
          <div class="col-6"><div class="form-check">
            <input class="form-check-input" type="checkbox" id="vpGenSymbols">
            <label class="form-check-label" for="vpGenSymbols">Symbols (!@#â€¦)</label>
          </div></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="vpGenUse">Use this password</button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script src="/static/vault.js"></script>
{% endblock %}
