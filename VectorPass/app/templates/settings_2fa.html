{% extends "base.html" %}

{% block nav_actions %}
  <a class="btn btn-outline-secondary btn-sm" href="/vault">‚Üê Vault</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-7 col-lg-6">
    <h2 class="mb-4">üîê Two-Factor Authentication</h2>

    {% if success %}
      <div class="alert alert-success">{{ success }}</div>
    {% endif %}
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {# ‚îÄ‚îÄ Current status ‚îÄ‚îÄ #}
    <div class="card shadow-sm mb-4">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <h5 class="mb-1">Authenticator App</h5>
          <p class="text-muted mb-0 small">TOTP codes via Google Authenticator, Authy, etc.</p>
        </div>
        {% if totp_enabled %}
          <span class="badge bg-success fs-6 px-3 py-2">Enabled</span>
        {% else %}
          <span class="badge bg-secondary fs-6 px-3 py-2">Disabled</span>
        {% endif %}
      </div>
    </div>

    {# ‚îÄ‚îÄ Setup flow: show QR after clicking "Set Up" ‚îÄ‚îÄ #}
    {% if pending_secret and qr_uri %}
    <div class="card shadow-sm mb-4 border-primary">
      <div class="card-header bg-primary text-white fw-semibold d-flex justify-content-between align-items-center">
        <span>Step 1 ‚Äî Scan this QR code</span>
        <form method="post" action="/settings/2fa/setup" class="m-0">
          <button type="submit" class="btn btn-sm btn-outline-light">‚Ü∫ New QR</button>
        </form>
      </div>
      <div class="card-body">
        <div class="alert alert-warning py-2 small mb-3">
          ‚ö†Ô∏è <strong>If you have a previous VectorPass entry in your authenticator app, delete it first</strong>, then scan this new QR code.
        </div>
        <p class="text-muted small mb-2">
          Open your authenticator app, <strong>delete any existing VectorPass entry</strong>, then scan the QR below or enter the key manually.
        </p>
        <div class="text-center mb-3">
          <img src="{{ qr_uri }}" alt="TOTP QR Code" class="border rounded p-2" style="max-width:210px">
        </div>
        <p class="text-center text-muted small mb-1">Or enter this key manually in your app:</p>
        <p class="text-center font-monospace fw-bold fs-5 mb-1 user-select-all" style="letter-spacing:.15em">{{ pending_secret }}</p>
        <p class="text-center text-muted small mb-3">Account: <strong>VectorPass</strong></p>

        <hr>
        <p class="fw-semibold mb-1">Step 2 ‚Äî Enter the 6-digit code shown in your app</p>
        <p class="text-muted small mb-2">The code refreshes every 30 seconds. Enter a <strong>fresh code</strong> (not one that's about to expire).</p>
        <form method="post" action="/settings/2fa/enable" autocomplete="off">
          <input type="hidden" name="pending_secret" value="{{ pending_secret }}">
          <div class="d-flex gap-2 mb-2">
            <input
              class="form-control font-monospace text-center fs-4"
              name="code"
              type="text"
              inputmode="numeric"
              pattern="[0-9]{6}"
              maxlength="6"
              placeholder="000000"
              autofocus
              required
              style="letter-spacing:.3em"
            >
            <button class="btn btn-success px-4" type="submit">Verify &amp; Enable</button>
          </div>
        </form>
        <p class="text-muted small">
          Code not working? Click <strong>‚Ü∫ New QR</strong> above to generate a fresh secret, delete the old entry from your app, and scan again.
        </p>
      </div>
    </div>

    {# ‚îÄ‚îÄ Not yet set up, 2FA disabled ‚îÄ‚îÄ #}
    {% elif not totp_enabled %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <p>Add an extra layer of security to your account. After enabling, you will be asked for a
           6-digit code from your authenticator app every time you log in.</p>
        <form method="post" action="/settings/2fa/setup">
          <button class="btn btn-primary" type="submit">Set Up Two-Factor Authentication</button>
        </form>
      </div>
    </div>

    {# ‚îÄ‚îÄ Already enabled ‚îÄ‚îÄ #}
    {% else %}
    <div class="card shadow-sm mb-4 border-danger">
      <div class="card-header text-danger fw-semibold">Disable Two-Factor Authentication</div>
      <div class="card-body">
        <p class="text-muted small mb-3">
          Enter a valid code from your authenticator app to confirm disabling 2FA.
        </p>
        <form method="post" action="/settings/2fa/disable" autocomplete="off">
          <div class="d-flex gap-2">
            <input
              class="form-control font-monospace text-center fs-5"
              name="code"
              type="text"
              inputmode="numeric"
              pattern="[0-9]{6}"
              maxlength="6"
              placeholder="000000"
              required
            >
            <button class="btn btn-danger px-4" type="submit">Disable 2FA</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}
