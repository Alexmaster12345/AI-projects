<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Trace ¬∑ Host Management</title>
    <link rel="stylesheet" href="/static/assets/dashboard.css?v=20260211_2" />
    <script defer src="/static/assets/dashboard.js?v=20260211_18"></script>
    <style>
        .hosts-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .page-header h1 {
            margin: 0;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .icon-btn {
            background: none !important;
            border: 1px solid #ccc !important;
            color: #333 !important;
            cursor: pointer !important;
            padding: 6px 10px !important;
            border-radius: 4px !important;
            margin-left: 8px !important;
            transition: all 0.2s ease !important;
            font-size: 18px !important;
            line-height: 1 !important;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000 !important;
        }
        
        .icon-btn:hover {
            background: #007bff !important;
            color: white !important;
            border-color: #007bff !important;
            transform: translateY(-1px) !important;
        }
        
        .icon-btn:active {
            transform: scale(0.95) !important;
        }
        
        .icon-btn .icon {
            display: inline-block !important;
            visibility: visible !important;
        }
        
        /* Ensure badge doesn't hide icons */
        .badge {
            display: flex !important;
            align-items: center !important;
            flex-wrap: nowrap !important;
        }
        
        .badge .icon-btn {
            flex-shrink: 0 !important;
        }
        .host-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .host-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .host-ip {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
        }
        .host-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .status-unknown {
            background: #666;
            color: #fff;
        }
        .status-deployable {
            background: var(--ok);
            color: #000;
        }
        .host-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
        }
        .info-label {
            color: var(--muted);
        }
        .info-value {
            color: var(--text);
        }
        .deploy-btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .deploy-btn:hover {
            background: var(--accent2);
        }
        .deploy-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .commands-section {
            background: var(--glass);
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        .commands-section.show {
            display: block;
        }
        .command-block {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: var(--ok);
            color: var(--bg);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .edit-btn {
            background: none;
            border: 1px solid #555;
            color: #aaa;
            border-radius: 5px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .edit-btn:hover {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        .summary-section {
            background: var(--glass);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }
        .summary-item {
            padding: 15px;
            background: var(--panel);
            border-radius: 8px;
        }
        .summary-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
        }
        .summary-label {
            color: var(--muted);
            margin-top: 5px;
        }
    </style>
  </head>
  <body class="sidebarAutoHide">
    <div class="appShell" id="appShell">
      <aside class="sidebar" id="sidebar" aria-label="Navigation">
        <div class="sideTop">
          <div class="brandRow">
            <div class="brand">System Trace</div>
          </div>

          <div class="sideSearchWrap">
            <input id="sideSearch" class="sideSearch" placeholder="Search‚Ä¶" autocomplete="off" />
          </div>
        </div>

        <nav class="sideNav" id="sideNav" aria-label="Main">
          <div class="sideGroup">
            <div class="sideGroupTitle">Monitoring</div>
            <a class="sideItem" href="/" data-action="dashboard" data-label="Dashboard">Dashboard</a>
            <a class="sideItem" href="#" data-action="problems" data-label="Problems">Problems</a>
            <a class="sideItem" href="/hosts" data-action="hosts" data-label="Hosts" aria-current="page">Hosts</a>
            <a class="sideItem" href="/overview" data-action="overview" data-label="Overview">Overview</a>
            <a class="sideItem" href="#" data-action="screens" data-label="Screens">Screens</a>
            <a class="sideItem" href="#" data-action="maps" data-label="Maps">Maps</a>
          </div>

          <div class="sideGroup">
            <div class="sideGroupTitle">Inventory</div>
            <a class="sideItem" href="/inventory" data-action="inventory" data-label="Inventory">Inventory</a>
          </div>

          <div class="sideGroup">
            <div class="sideGroupTitle">Reports</div>
            <a class="sideItem" href="#" data-action="reports" data-label="Reports">Reports</a>
          </div>

          <div class="sideGroup">
            <div class="sideGroupTitle">Configuration</div>
            <a class="sideItem" href="#" data-action="configuration" data-label="Configuration">Configuration</a>
          </div>

          <div class="sideGroup">
            <div class="sideGroupTitle">Administration</div>
            <a class="sideItem" href="/users" data-action="users" data-label="Users">Users</a>
            <a class="sideItem" href="/user-groups" data-action="user-groups" data-label="User groups">User groups</a>
            <a class="sideItem" href="#" onclick="window._hostsPageLoad(); return false;" data-action="refresh" data-label="Refresh">üîÑ Refresh</a>
          </div>
        </nav>

        <div class="sideBottom" aria-label="Secondary">
          <a class="sideItem" href="#" data-action="support" data-label="Support">Support</a>
          <a class="sideItem" href="#" data-action="share" data-label="Share">Share</a>
          <a class="sideItem" href="#" data-action="help" data-label="Help">Help</a>
          <a class="sideItem" href="#" data-action="settings" data-label="User settings">User settings</a>
          <form class="sideLogout" method="post" action="/logout">
            <button class="sideItem sideBtn" type="submit" data-action="logout">Sign out</button>
          </form>
        </div>
      </aside>

      <div class="content" id="content">
        <div class="frame">
          <div class="hud">
            <header>
              <div class="headLeft">
                <button id="sideToggle" class="sideToggle" type="button" aria-label="Toggle menu" title="Menu">
                  <span aria-hidden="true">‚â°</span>
                </button>
                <div>
                  <div id="date" class="date">‚Äî</div>
                  <div class="title">HOST MANAGEMENT</div>
                </div>
              </div>
              <div class="badge">
                <span class="dot"></span>
                <span id="conn">connecting‚Ä¶</span> ¬∑ <span id="host">‚Äî</span>
            </div>
            <div style="display: flex; gap: 8px; margin-left: 15px; position: relative; z-index: 9999;">
                <button id="autoDiscoverIcon" onclick="window.startAutoDiscovery()" title="Auto Discover" 
                        style="background: #FF0000 !important; color: #FFFFFF !important; border: 3px solid #000000 !important; padding: 12px 20px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 20px !important; font-weight: bold !important; display: inline-block !important; align-items: center !important; gap: 8px !important; position: relative !important; z-index: 9999 !important; box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;">
                    üîç AUTO DISCOVER
                </button>
                <button id="refreshIcon" onclick="window._hostsPageLoad()" title="Refresh" 
                        style="background: #00FF00 !important; color: #000000 !important; border: 3px solid #000000 !important; padding: 12px 20px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 20px !important; font-weight: bold !important; display: inline-block !important; align-items: center !important; gap: 8px !important; position: relative !important; z-index: 9999 !important; box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;">
                    üîÑ REFRESH
                </button>
            </div>
            </header>
          </div>

          <div class="hosts-container">
        <h1>üñ•Ô∏è Host Management</h1>
        
        <div class="summary-section">
            <h2>üìä Discovery Summary</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number">4</div>
                    <div class="summary-label">Total Hosts</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">0</div>
                    <div class="summary-label">Deployable</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">0</div>
                    <div class="summary-label">OS Types</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number">192.168.50.0/24</div>
                    <div class="summary-label">Network</div>
                </div>
            </div>
        </div>
        
        <h2>üñ•Ô∏è Discovered Hosts</h2>
        <div id="hostsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:12px;">
          <div style="color:#888;padding:20px;">Loading hosts‚Ä¶</div>
        </div>

        <!-- Edit Host Modal -->
        <div id="editHostModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
            <div style="background:#1e1e2e; border:1px solid #444; border-radius:10px; padding:30px; width:420px; max-width:95vw; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
                <h2 style="margin:0 0 20px 0; color:#e0e0e0;">‚úèÔ∏è Edit Host</h2>
                <input type="hidden" id="editHostId">
                <div style="margin-bottom:14px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px; font-size:13px;">Display Name</label>
                    <input id="editHostName" type="text" style="width:100%; padding:8px 10px; border-radius:5px; border:1px solid #555; background:#2a2a3e; color:#e0e0e0; font-size:14px; box-sizing:border-box;" placeholder="e.g. Web Server 01">
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px; font-size:13px;">IP Address / Hostname</label>
                    <input id="editHostAddress" type="text" style="width:100%; padding:8px 10px; border-radius:5px; border:1px solid #555; background:#2a2a3e; color:#e0e0e0; font-size:14px; box-sizing:border-box;" placeholder="e.g. 192.168.1.10">
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px; font-size:13px;">Type</label>
                    <select id="editHostType" style="width:100%; padding:8px 10px; border-radius:5px; border:1px solid #555; background:#2a2a3e; color:#e0e0e0; font-size:14px; box-sizing:border-box;">
                        <option value="">-- Select type --</option>
                        <option value="rack-server">üñ•Ô∏è Rack Server</option>
                        <option value="linux">üêß Linux Server</option>
                        <option value="windows">ü™ü Windows Server</option>
                        <option value="switch">üîÄ Network Switch</option>
                        <option value="router">üì° Router</option>
                        <option value="firewall">üõ°Ô∏è Firewall</option>
                        <option value="patch-panel">üîå Patch Panel</option>
                        <option value="network">üåê Network Device</option>
                        <option value="other">üíª Other</option>
                    </select>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px; font-size:13px;">Notes</label>
                    <textarea id="editHostNotes" rows="3" style="width:100%; padding:8px 10px; border-radius:5px; border:1px solid #555; background:#2a2a3e; color:#e0e0e0; font-size:14px; box-sizing:border-box; resize:vertical;" placeholder="Optional notes..."></textarea>
                </div>
                <div id="editHostError" style="color:#ff6b6b; font-size:13px; margin-bottom:10px; display:none;"></div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="closeEditModal()" style="padding:9px 18px; border-radius:5px; border:1px solid #555; background:#333; color:#ccc; cursor:pointer; font-size:14px;">Cancel</button>
                    <button onclick="saveHost()" id="saveHostBtn" style="padding:9px 18px; border-radius:5px; border:none; background:#007bff; color:white; cursor:pointer; font-size:14px; font-weight:600;">üíæ Save</button>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <h2>üìÅ Available Agent Files</h2>
            <p>Agent files have been created for all supported operating systems:</p>
            <ul>
                <li><strong>Ubuntu/Debian:</strong> apt-based systems</li>
                <li><strong>RHEL/CentOS/Rocky:</strong> yum/dnf-based systems</li>
            </ul>
            <p>Each agent includes:</p>
            <ul>
                <li>Python monitoring agent (system-trace_agent.py)</li>
                <li>Deployment script (deploy_*_agent.sh)</li>
                <li>Systemd service (system-trace-agent.service)</li>
                <li>SNMP configuration (snmpd.conf)</li>
            </ul>
        </div>
    </div>
        </div>
      </div>
    </div>

    <style>
    /* Force auto-hide behavior for this page */
    body.sidebarAutoHide:not(.sidebarHover):not(.sidebarOpen) .sidebar {
      transform: translateX(calc(-100% + 14px)) !important;
      transition: transform 180ms ease !important;
    }
    
    body.sidebarAutoHide.sidebarHover .sidebar,
    body.sidebarAutoHide.sidebarOpen .sidebar {
      transform: translateX(0) !important;
      transition: transform 180ms ease !important;
    }
    
    body.sidebarAutoHide:not(.sidebarHover):not(.sidebarOpen) .sidebar::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(110, 231, 255, 0.1), transparent);
      border-right: 1px solid rgba(110, 231, 255, 0.2);
      pointer-events: none;
    }
    
    /* Ensure content adjusts properly */
    body.sidebarAutoHide .content {
      margin-left: 14px !important;
      transition: margin-left 180ms ease !important;
    }
    
    body.sidebarAutoHide.sidebarHover .content,
    body.sidebarAutoHide.sidebarOpen .content {
      margin-left: var(--side-w, 260px) !important;
    }
  </style>
    <script>
      // Simple auto-hide sidebar implementation
      (function() {
        let sidebarHover = false;
        let mouseTimer = null;
        
        function initAutoHide() {
          const sidebar = document.getElementById('sidebar');
          if (!sidebar) return;
          
          // Force the auto-hide class
          document.body.classList.add('sidebarAutoHide');
          
          // Mouse move handler
          function onMouseMove(e) {
            clearTimeout(mouseTimer);
            const x = e.clientX;
            
            if (x <= 30) {
              if (!sidebarHover) {
                sidebarHover = true;
                document.body.classList.add('sidebarHover');
              }
            } else if (x > 100) {
              if (sidebarHover) {
                sidebarHover = false;
                document.body.classList.remove('sidebarHover');
              }
            }
          }
          
          // Add event listener
          document.addEventListener('mousemove', onMouseMove, { passive: true });
          
          // Sidebar hover handlers
          sidebar.addEventListener('mouseenter', function() {
            sidebarHover = true;
            document.body.classList.add('sidebarHover');
          });
          
          sidebar.addEventListener('mouseleave', function() {
            sidebarHover = false;
            document.body.classList.remove('sidebarHover');
          });
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initAutoHide);
        } else {
          initAutoHide();
        }
      })();
      
    </script>
    <script>

      function openEditModal(btn) {
          document.getElementById('editHostId').value = btn.dataset.id;
          document.getElementById('editHostName').value = btn.dataset.name || '';
          document.getElementById('editHostAddress').value = btn.dataset.address || '';
          document.getElementById('editHostType').value = btn.dataset.type || '';
          document.getElementById('editHostNotes').value = btn.dataset.notes || '';
          document.getElementById('editHostError').style.display = 'none';
          const modal = document.getElementById('editHostModal');
          modal.style.display = 'flex';
      }

      function closeEditModal() {
          document.getElementById('editHostModal').style.display = 'none';
      }

      async function saveHost() {
          const id = document.getElementById('editHostId').value;
          const name = document.getElementById('editHostName').value.trim();
          const address = document.getElementById('editHostAddress').value.trim();
          const type = document.getElementById('editHostType').value;
          const notes = document.getElementById('editHostNotes').value.trim();
          const errEl = document.getElementById('editHostError');
          const saveBtn = document.getElementById('saveHostBtn');

          if (!name || !address) {
              errEl.textContent = 'Name and IP Address are required.';
              errEl.style.display = 'block';
              return;
          }

          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving‚Ä¶';
          errEl.style.display = 'none';

          try {
              const resp = await fetch(`/api/admin/hosts/${id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ name, address, type: type || null, tags: [], notes: notes || null })
              });
              if (!resp.ok) {
                  const data = await resp.json();
                  throw new Error(data.detail || 'Save failed');
              }
              const host = await resp.json();
              // Update the card in the DOM
              const card = document.querySelector(`.host-card[data-host-id="${id}"]`);
              if (card) {
                  card.querySelector('.host-ip').textContent = host.address;
                  const editBtn = card.querySelector('.edit-btn');
                  editBtn.dataset.name = host.name;
                  editBtn.dataset.address = host.address;
                  editBtn.dataset.type = host.type || '';
                  editBtn.dataset.notes = host.notes || '';
              }
              closeEditModal();
          } catch (e) {
              errEl.textContent = e.message;
              errEl.style.display = 'block';
          } finally {
              saveBtn.disabled = false;
              saveBtn.textContent = 'üíæ Save';
          }
      }

      // Close modal on backdrop click
      document.getElementById('editHostModal').addEventListener('click', function(e) {
          if (e.target === this) closeEditModal();
      });

      function toggleCommands(hostId) {
          const section = document.getElementById('commands-' + hostId);
          section.classList.toggle('show');
      }
      
      function copyCommands(hostId) {
          const commandsText = document.getElementById('commands-' + hostId).innerText;
          navigator.clipboard.writeText(commandsText).then(() => {
              alert('Commands copied to clipboard!');
          });
      }
      
      const DEVICE_ICONS = {
        'rack-server':'üñ•Ô∏è','switch':'üîÄ','router':'üåê',
        'firewall':'üõ°Ô∏è','patch-panel':'ÔøΩÔøΩ','linux':'üêß',
        'windows':'ü™ü','network':'üì°','other':'üíª'
      };

      async function loadHosts() {
        const grid = document.getElementById('hostsGrid');
        if (!grid) { console.error('hostsGrid not found'); return; }
        try {
          const [hosts, agentStatus] = await Promise.all([
            fetch('/api/hosts', {credentials:'same-origin'}).then(r => r.ok ? r.json() : []),
            fetch('/api/agent/status', {credentials:'same-origin'}).then(r => r.ok ? r.json() : {})
          ]);
          const arr = Array.isArray(hosts) ? hosts : [];
          if (arr.length === 0) {
            grid.innerHTML = '<div style="color:#888;padding:20px;grid-column:1/-1;">No hosts found. Run Auto Discover to scan your network.</div>';
            return;
          }
          grid.innerHTML = arr.map(h => {
            const icon = DEVICE_ICONS[h.type] || 'üíª';
            const agentEntry = agentStatus[h.address] || agentStatus[h.name] || null;
            const agentOnline = agentEntry && agentEntry.status === 'online';
            const agentBadge = agentEntry
              ? (agentOnline
                  ? '<span style="background:rgba(76,175,80,0.15);color:#4caf50;border:1px solid rgba(76,175,80,0.4);padding:2px 8px;border-radius:10px;font-size:11px;">‚óè Online</span>'
                  : '<span style="background:rgba(158,158,158,0.15);color:#9e9e9e;border:1px solid rgba(158,158,158,0.4);padding:2px 8px;border-radius:10px;font-size:11px;">‚óè Offline</span>')
              : '<span style="background:rgba(244,67,54,0.12);color:#f44336;border:1px solid rgba(244,67,54,0.35);padding:2px 8px;border-radius:10px;font-size:11px;">‚úï No Agent</span>';
            const safeName = (h.name||h.address||'').replace(/'/g,"&#39;");
            return `<div class="host-card" data-host-id="${h.id}">
              <div class="host-header">
                <div class="host-ip">${icon} ${h.name||h.address}</div>
                <div style="display:flex;align-items:center;gap:6px;">
                  ${agentBadge}
                  <button class="edit-btn" onclick="_hostsPageEditModal(this)"
                    data-id="${h.id}" data-name="${h.name||''}" data-address="${h.address||''}"
                    data-type="${h.type||''}" data-notes="${h.notes||''}" title="Edit host">‚úèÔ∏è</button>
                </div>
              </div>
              <div class="host-info">
                <div class="info-item"><span class="info-label">IP:</span><span class="info-value">${h.address||'‚Äî'}</span></div>
                <div class="info-item"><span class="info-label">Type:</span><span class="info-value">${h.type||'Unknown'}</span></div>
                <div class="info-item"><span class="info-label">Tags:</span><span class="info-value">${(h.tags||[]).join(', ')||'‚Äî'}</span></div>
                <div class="info-item"><span class="info-label">Notes:</span><span class="info-value">${h.notes||'‚Äî'}</span></div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                <a href="/host/${h.id}" class="deploy-btn" style="text-decoration:none;display:inline-block;padding:6px 14px;font-size:12px;">üìä Monitor</a>
                <button class="deploy-btn" style="background:#c0392b;" onclick="window._hostsPageDelete(${h.id},'${safeName}')">üóëÔ∏è Delete</button>
              </div>
            </div>`;
          }).join('');
        } catch(e) {
          console.error('loadHosts error:', e);
          grid.innerHTML = '<div style="color:#f44336;padding:20px;grid-column:1/-1;">Failed to load hosts: ' + (e.message||e) + '</div>';
        }
      }

      async function refreshHosts() {
        const btn = document.getElementById('refreshIcon');
        const orig = btn ? btn.innerHTML : '';
        if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Refreshing...'; }
        await loadHosts();
        if (btn) {
          btn.innerHTML = '‚úÖ Done';
          setTimeout(() => { btn.disabled = false; btn.innerHTML = orig; }, 1500);
        }
      }

      async function deleteHost(id, name) {
        if (!confirm('Delete host: ' + name + '?')) return;
        await fetch('/api/admin/hosts/' + id, { method: 'DELETE', credentials: 'same-origin' });
        await loadHosts();
      }

      async function startAutoDiscovery() {
        const btn = document.getElementById('autoDiscoverIcon');
        const orig = btn ? btn.innerHTML : '';
        if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Discovering...'; btn.style.background = '#6c757d'; }
        try {
          const response = await fetch('/api/discovery/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
          });
          const result = await response.json();
          if (response.ok) {
            if (btn) { btn.innerHTML = '‚úÖ ' + (result.message || 'Done'); btn.style.background = '#28a745'; }
          } else {
            if (btn) { btn.innerHTML = '‚ùå Failed'; btn.style.background = '#dc3545'; }
          }
        } catch(e) {
          console.error('Discovery error:', e);
          if (btn) { btn.innerHTML = '‚ùå Error'; btn.style.background = '#dc3545'; }
        }
        // Always refresh grid after discovery
        await loadHosts();
        if (btn) {
          setTimeout(() => { btn.disabled = false; btn.innerHTML = orig; btn.style.background = ''; }, 2500);
        }
      }

      // Expose globals
      window._hostsPageLoad = loadHosts;
      window._hostsPageRefresh = refreshHosts;
      window._hostsPageDelete = deleteHost;
      window._hostsPageStartDiscovery = startAutoDiscovery;
      window._hostsPageEditModal = openEditModal;

      // Run after ALL scripts (including defer) have executed
      window.addEventListener('load', loadHosts);
    </script>

  </body>
</html>